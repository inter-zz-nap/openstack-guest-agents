#!/bin/sh

# vim: tabstop=4 shiftwidth=4 softtabstop=4
#
#  Copyright (c) 2011 Openstack, LLC.
#  All Rights Reserved.
#
#     Licensed under the Apache License, Version 2.0 (the "License"); you may
#     not use this file except in compliance with the License. You may obtain
#     a copy of the License at
#
#          http://www.apache.org/licenses/LICENSE-2.0
#
#     Unless required by applicable law or agreed to in writing, software
#     distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#     WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#     License for the specific language governing permissions and limitations
#     under the License.
#

prefix="@prefix@"
exec_prefix="@exec_prefix@"
sbindir="@sbindir@"
datadir="@datarootdir@/@PACKAGE@"
dataversdir="@datarootdir@/@PACKAGE@/@PACKAGE_VERSION@"
version="@PACKAGE_VERSION@"

umask 077

my_dir=`dirname $0`

if [ -d $dataversdir ] ; then
	# This version is already installed
	echo "Version ${version} is already installed"
	exit 1
fi

if [ ! -d $datadir ] ; then
    mkdir $datadir
fi

# Copy our version subdirectory to the target
cp -R ${my_dir}/${dataversdir} ${dataversdir}

# Install the init file symlink
if [ -d /etc/init.d ]; then
    INITDIR=/etc/init.d
elif [ -d /etc/rc.d ]; then
    INITDIR=/etc/rc.d
fi

if [ "x${INITDIR}x" = "xx" ]; then
    echo ERROR: Could not determine location of init directory
    exit 1
fi

rm -f ${INITDIR}/nova-agent
ln -s ${dataversdir}/etc/nova-agent.init ${INITDIR}/nova-agent

# Enable the new init script
if [ -x /usr/sbin/update-rc.d ]; then
    # Debian/Ubuntu
    update-rc.d nova-agent start 20 2 3 4 5 . stop 20 0 1 6 . > /dev/null 2>&1
elif [ -x /sbin/chkconfig ]; then
    # Red Hat/CentOS
    chkconfig nova-agent on > /dev/null 2>&1
elif [ -x /sbin/rc-update ]; then
    # Gentoo
    rc-update add nova-agent default > /dev/null 2>&1
fi

# Install the new nova-agent symlink
rm -f ${sbindir}/nova-agent
ln -s ${dataversdir}/sbin/nova-agent ${sbindir}/nova-agent 

# Install the new nova-agent config file symlink
rm -f ${datadir}/nova-agent.py
ln -s ${dataversdir}/nova-agent.py ${datadir}/nova-agent.py

# Remove the old agent if it exists
if [ -f /usr/sbin/agent-smith ] ; then
    rm -f /usr/sbin/agent-smith
    rm -rf /usr/share/agent-smith
    rm -f /var/log/agent-smith.log
fi

# Restart (or start) the agent
#sh ${INITDIR}/nova-agent restart

exit 0
